name: ğŸ“¦ Manage Store Assets

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - validate
          - generate
          - upload
          - sync
      developer:
        description: 'Developer account (or "all")'
        required: true
        default: 'all'
        type: string

jobs:
  manage-assets:
    name: ğŸ“¦ ${{ github.event.inputs.action }} Store Assets
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ Install Dependencies
        run: |
          pip install -r requirements.txt || echo "No requirements.txt found"

      - name: âœ… Validate Store Assets
        if: github.event.inputs.action == 'validate'
        run: |
          echo "ğŸ” Validating store assets..."
          DEVELOPER="${{ github.event.inputs.developer }}"
          
          if [ "$DEVELOPER" = "all" ]; then
            DIRS=$(find store_assets -type d -mindepth 1 -maxdepth 1)
          else
            DEVELOPER_NAME=$(echo "$DEVELOPER" | sed 's/[0-9]*_//')
            DIRS="store_assets/$DEVELOPER_NAME"
          fi
          
          for dir in $DIRS; do
            if [ -d "$dir" ]; then
              echo "ğŸ“ Checking: $dir"
              for app_dir in "$dir"/*; do
                if [ -d "$app_dir" ]; then
                  APP=$(basename "$app_dir")
                  echo "  ğŸ“± App: $APP"
                  
                  # Check required files
                  REQUIRED=("short_description.txt" "full_description.txt" "privacy_policy.txt")
                  for file in "${REQUIRED[@]}"; do
                    if [ -f "$app_dir/$file" ]; then
                      echo "    âœ… $file"
                    else
                      echo "    âŒ Missing: $file"
                    fi
                  done
                  
                  # Check AAB file
                  if ls "$app_dir"/*.aab 1> /dev/null 2>&1; then
                    AAB_SIZE=$(du -h "$app_dir"/*.aab | cut -f1)
                    echo "    âœ… AAB file: $AAB_SIZE"
                  else
                    echo "    âš ï¸  No AAB file found"
                  fi
                fi
              done
            fi
          done

      - name: ğŸ¨ Generate Store Assets
        if: github.event.inputs.action == 'generate'
        run: |
          echo "ğŸ¨ Generating store assets..."
          python3 generate_store_assets.py || echo "Using existing assets"

      - name: ğŸ“¤ Upload to GitHub Releases
        if: github.event.inputs.action == 'upload'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: store-assets-${{ github.run_number }}
          name: Store Assets #${{ github.run_number }}
          body: |
            ## ğŸ“¦ Store Assets Release
            
            Store assets for Google Play Console submission.
            
            **Generated:** ${{ github.event.head_commit.timestamp }}
          files: store_assets/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”„ Sync Assets
        if: github.event.inputs.action == 'sync'
        run: |
          echo "ğŸ”„ Syncing store assets..."
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add store_assets/
          git diff --staged --quiet || git commit -m "ğŸ¤– Sync store assets"
          git push || echo "No changes to sync"

